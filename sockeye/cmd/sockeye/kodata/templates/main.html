

<div class="sockeye-container mdl-grid">
    <div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"></div>
    <div class="sockeye-content mdl-color--white mdl-shadow--4dp content mdl-color-text--grey-800 mdl-cell mdl-cell--8-col">
        <div class="sockeye-crumbs mdl-color-text--grey-500">
            Subject &gt; Thing thing thing
        </div>
        <table class="sockeye-table mdl-data-table mdl-js-data-table mdl-shadow--2dp">
            <thead>
            <tr>
                <th class="mdl-data-table__cell--non-numeric">Type</th>
                <th class="mdl-data-table__cell--non-numeric">Data</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td class="mdl-data-table__cell--non-numeric">
                    <span class="mdl-chip">
                        <span class="mdl-chip__text">Basic Chip</span>
                    </span>
                </td>
                <td class="mdl-data-table__cell--non-numeric">$2.90</td>
            </tr>
            <tr>
                <td class="mdl-data-table__cell--non-numeric">Plywood (Birch)</td>
                <td class="mdl-data-table__cell--non-numeric">$1.25</td>
            </tr>
            <tr>
                <td class="mdl-data-table__cell--non-numeric">Laminate (Gold on Blue)</td>
                <td class="mdl-data-table__cell--non-numeric">$2.35</td>
            </tr>
            </tbody>
        </table>


        <div id="log"></div>

    </div>
    <div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"></div>
</div>


<script>

    injectPad = function(container) {
        let pad = document.createElement("div");
        pad.className = "mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone";
        container.appendChild(pad);
    };

    makeTable = function(subject) {
        let c = document.createElement("div");
        c.className = "sockeye-content mdl-color--white mdl-shadow--4dp content mdl-color-text--grey-800 mdl-cell mdl-cell--8-col";

        let s = document.createElement("div");
        s.className = "sockeye-crumbs mdl-color-text--grey-500";
        s.innerText = "Subject > " + subject;

        c.appendChild(s);

        let t = document.createElement("table");
        t.className = "sockeye-table mdl-data-table mdl-js-data-table mdl-shadow--2dp";

        let tHead = document.createElement("thead");

        let tr = document.createElement("tr");

        let th1 = document.createElement("th");
        th1.className = "mdl-data-table__cell--non-numeric";
        th1.innerText = "Type";
        tr.appendChild(th1);

        let th2 = document.createElement("th");
        th2.className = "mdl-data-table__cell--non-numeric";
        th2.innerText = "Data";
        tr.appendChild(th2);

        tHead.appendChild(tr);

        t.appendChild(tHead);

        let tBody = document.createElement("tbody");
        t.appendChild(tBody);

        c.appendChild(t);
        return c
    };

    appendRow = function (t, e) {
        let tbody = t.getElementsByTagName("tbody")[0]

        let tr = document.createElement("tr");

        let td1 = document.createElement("td");
        td1.className = "mdl-data-table__cell--non-numeric";


        let os = document.createElement("span");
        os.className = "mdl-chip";

        let is = document.createElement("span");
        is.className = "mdl-chip__text";
        is.innerText = e["type"];

        os.appendChild(is);

        td1.appendChild(os);

        tr.appendChild(td1);

        let td2 = document.createElement("td");
        td2.className = "mdl-data-table__cell--non-numeric";
        td2.innerText = JSON.stringify(e["data"]);

        tr.appendChild(td2);

        tbody.appendChild(tr)
    };

    window.onload = function () {

        let subjects = {};

        let main = document.getElementsByTagName("main")[0].getElementsByClassName("sockeye-container")[0];


        console.log("Protocol: " + location.protocol);
        let wsURL = "ws://" + document.location.host + "/ws";
        if (location.protocol === 'https:') {
            wsURL = "wss://" + document.location.host + "/ws";
        }
        console.log("WS URL: " + wsURL);


        function appendLog(log, item) {
            let doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
            log.appendChild(item);
            if (doScroll) {
                log.scrollTop = log.scrollHeight - log.clientHeight;
            }
        }

        sock = new WebSocket(wsURL);

        sock.onopen = function () {
            console.log("connected to " + wsURL);
        };

        sock.onclose = function (e) {
            console.log("connection closed (" + e.code + ")");
        };

        sock.onmessage = function (e) {
            let t = JSON.parse(JSON.parse(e.data)); // at the moment the ws sends down a double encoded thing.

            let key = "no-subject";
            if (t["subject"])  {
                key = t["subject"]
            }

            let log = subjects[key];

            if (!log) {
                log = makeTable(key);

                injectPad(main);
                main.appendChild(log);
                injectPad(main);

                subjects[key] = log;
            }

            appendRow(log, t)
        };

    };
</script>